import os
from flask import Flask, request, render_template
from predict import predict_image_class  
from werkzeug.utils import secure_filename
from flask import Flask, render_template,request,flash,redirect,url_for,session
import sqlite3


app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads'
app.config['ALLOWED_EXTENSIONS'] = {'jpg', 'jpeg', 'png'}
val = None
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']
app.secret_key="123"
con=sqlite3.connect("database.db")
con.execute("create table if not exists customer(pid integer primary key,name text,address text,contact integer,mail text)")
con.close()

@app.route('/')
def index():
    return render_template('upload.html')

@app.route('/about')
def about():
    return render_template('about.html')



#image proccess

@app.route('/customer',methods=["GET","POST"])
def upload_image():
    if request.method == 'POST':
        if 'file' not in request.files:
            return "No file part"
        file = request.files['file']
        if file.filename == '':
            n="No selected file"
            return render_template('upload.html',data=n)
        if file and allowed_file(file.filename):
            global filename
            filename = secure_filename(file.filename)
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            file.save(filepath)
            global val
            val= predict_image_class(filepath)
            #return f"name {val}"
            return render_template('upload.html',data=val)           
    return render_template('upload.html')

#get tips and medicine


    

#main
if __name__ == '__main__':
    app.run(debug=True)








    import tensorflow as tf
from tensorflow.keras.preprocessing import image
import numpy as np  
 
model = tf.keras.models.load_model('models/plant.h5')

# Function to preprocess the user-uploaded image
def preprocess_image(user_image_path):
    img = image.load_img(user_image_path, target_size=(224,224,3))
    img = image.img_to_array(img)
    img = np.expand_dims(img, axis=0)
    img = img / 255.0  
    return img

# Function to predict the class of the user-uploaded image
def predict_image_class(user_image_path):
    img = preprocess_image(user_image_path)
    predictions = model.predict(img)
    predicted_class_index = np.argmax(predictions)
    class_labels = ['Apple_scab', 'Apple Black rot', 'Apple Cedar apple rust',
                    'Apple healthy','Blueberry healthy','Cherry healthy',
                    'Cherry Powdery mildew','Corn Cercospora leaf spot Gray leaf spot','Corn Common rust ',
                    'Corn healthy','Corn Northern Leaf Blight','Grape Black rot',
                    'Grape Esca','Grape Leaf blight','Grape healthy',
                    'Orange Haunglongbing','Peach Bacterial spot'
                    ,'Peach healthy','Pepper bell Bacterial spot','Pepper bell healthy',
                    'Potato Early blight','Potato healthy','Potato Late blight',
                    'Raspberry healthy','Soybean healthy','Squash Powdery mildew'
                    ,'Strawberry healthy','Strawberry Leaf scorch','Tomato Bacterial spot',
                    'Tomato Early blight','Tomato healthy','Tomato Late blight',
                    'Tomato Leaf Mold','Tomato Septoria leaf spot','Tomato Spider mites',
                    'Tomato Target Spot','Tomato mosaic virus','Tomato Yellow Leaf Curl Virus'] 
  

    predicted_class = class_labels[predicted_class_index]
    #confidence = predictions[0][predicted_class_index]
    return predicted_class

# Example usage
#user_uploaded_image_path = 'strowberry.jpeg'
#predicted_class, confidence = predict_image_class(user_uploaded_image_path)

#print(f"Predicted Class: {predicted_class} with confidence: {confidence:.2f}")
